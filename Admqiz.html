<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Quiz</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --primary:#2563eb;
  --bg:#f4f6f8;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --success:#16a34a;
}

*{
  box-sizing:border-box;
}

body{
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  margin:0;
  padding:20px;
  color:var(--text);
}

/* TITRES */
h1{
  text-align:center;
  margin-bottom:25px;
  color:var(--primary);
}

h3{
  margin-top:30px;
  margin-bottom:10px;
}

/* INPUTS */
input{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:1px solid var(--border);
  border-radius:8px;
  font-size:14px;
}

input[readonly]{
  background:#f9fafb;
  color:var(--muted);
}

/* BOUTONS */
button{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  font-size:14px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  opacity:0.9;
  transform:translateY(-1px);
}

/* SECTIONS */
ul{
  list-style:none;
  padding:0;
}

li{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

li b{
  display:block;
  margin-bottom:6px;
}

/* HR */
hr{
  border:none;
  border-top:1px dashed var(--border);
  margin:12px 0;
}

/* ZONE QUIZ LIST */
#all-quiz-list li{
  position:relative;
}

/* MOBILE */
@media (max-width:600px){
  body{
    padding:15px;
  }
}
</style>
</head>

<body>

<h1>Admin Quiz</h1>

<h3>ID du quiz</h3>
<input id="IdQiz" placeholder="ex: html_debutant_01">
<button onclick="loadQuiz()">Voir quiz</button>
<button onclick="deleteQuiz()" style="background:#dc2626; margin-top:10px">
  üß® Supprimer ce quiz
</button>

<h3>Lien du quiz</h3>
<input id="quiz-link" readonly style="width:100%">
<button onclick="copyLink()">Copier le lien</button>

<h3>Ajouter une question (max 5)</h3>
<input id="q" placeholder="Question"><br>
<input id="o0" placeholder="Option 1">
<input id="o1" placeholder="Option 2">
<input id="o2" placeholder="Option 3"><br>
<input id="a" type="number" placeholder="Bonne r√©ponse (0-2)">
<input id="points" type="number" placeholder="Points">
<button onclick="addQuestion()">Ajouter</button>

<h3>Questions du quiz</h3>
<ul id="question-list"></ul>
<h3>üìã Liste de tous les quiz</h3>
<ul id="all-quiz-list"></ul>

<!-- ===== MODAL EDIT QUESTION ===== -->
<div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center; z-index:999;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px;">
    <h3>‚úèÔ∏è Modifier la question</h3>

    <input id="m-question" placeholder="Question">
    <input id="m-o0" placeholder="Option 1">
    <input id="m-o1" placeholder="Option 2">
    <input id="m-o2" placeholder="Option 3">
    <input id="m-answer" type="number" placeholder="Bonne r√©ponse (0-2)">
    <input id="m-points" type="number" placeholder="Points">

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="saveEdit()">üíæ Enregistrer</button>
      <button onclick="closeModal()" style="background:#6b7280">Annuler</button>
    </div>
  </div>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAQeHWr_vUiQmVVgJJ_cOF9qrCCLd7IJNc",
  authDomain: "ayiweb.firebaseapp.com",
  databaseURL: "https://ayiweb-default-rtdb.firebaseio.com",
  projectId: "ayiweb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= LIEN QUIZ ================= */
function generateLink(){
  const quizId = document.getElementById("IdQiz").value.trim();
  if(!quizId) return "";
  return `${window.location.origin}/chaine/quiz.html?quiz=${quizId}`;
}

document.getElementById("IdQiz").addEventListener("input", () => {
  document.getElementById("quiz-link").value = generateLink();
});

function copyLink(){
  const input = document.getElementById("quiz-link");
  if(!input.value) return alert("Entre un quiz ID");
  input.select();
  document.execCommand("copy");
  alert("Lien copi√© ‚úÖ");
}

/* ================= AJOUT QUESTION ================= */
function addQuestion(){
  const quizId = document.getElementById("IdQiz").value.trim();
  const question = document.getElementById("q").value;
  const o0 = document.getElementById("o0").value;
  const o1 = document.getElementById("o1").value;
  const o2 = document.getElementById("o2").value;
  const answer = parseInt(document.getElementById("a").value);
  const points = parseInt(document.getElementById("points").value);

  if(!quizId || !question || !o0 || !o1 || !o2 || isNaN(answer) || isNaN(points)){
    alert("Tout est obligatoire");
    return;
  }

  const ref = db.ref(`quizs/${quizId}/questions`);

  ref.once("value", snap => {
    if(snap.numChildren() >= 5){
      alert("Maximum 5 questions pour ce quiz");
      return;
    }

    ref.push({
      question,
      options: [o0, o1, o2],
      answer,
      points
    });

    db.ref(`quizs/${quizId}/meta`).set({
      createdAt: Date.now()
    });

    alert("Question ajout√©e ‚úÖ");
    loadQuiz();

    document.getElementById("q").value = "";
    document.getElementById("o0").value = "";
    document.getElementById("o1").value = "";
    document.getElementById("o2").value = "";
    document.getElementById("a").value = "";
    document.getElementById("points").value = "";
  });
}

/* ================= AFFICHER QUIZ ================= */

function loadQuiz(){
  const quizId = document.getElementById("IdQiz").value.trim();
  if(!quizId) return alert("Entre un quiz ID");

  const list = document.getElementById("question-list");
  list.innerHTML = "";

  db.ref(`quizs/${quizId}/questions`).once("value", snap => {
    if(!snap.exists()){
      list.innerHTML = "<li>Aucune question</li>";
      return;
    }

    snap.forEach(c => {
      const qKey = c.key;
      const q = c.val();

      list.innerHTML += `
        <li>
          <b>${q.question}</b><br>
          ${q.options.join(" | ")}<br>
          R√©ponse: ${q.answer} | Points: ${q.points}<br><br>

          <button onclick="editQuestion('${quizId}','${qKey}')">‚úèÔ∏è Modifier</button>
          <button onclick="deleteQuestion('${quizId}','${qKey}')"
            style="background:#dc2626;margin-left:5px">
            üóëÔ∏è Supprimer
          </button>
        </li>
      `;
    });
  });
}

// ===== SUPPRIMER QUESTION =====
function deleteQuestion(quizId, qKey){
  if(!confirm("Supprimer cette question ?")) return;

  db.ref(`quizs/${quizId}/questions/${qKey}`).remove()
    .then(() => {
      alert("Question supprim√©e ‚úÖ");
      loadQuiz();
    });
}

// ===== MODIFIER QUESTION =====

let currentQuizId = null;
let currentQKey = null;

function editQuestion(quizId, qKey){
  currentQuizId = quizId;
  currentQKey = qKey;

  db.ref(`quizs/${quizId}/questions/${qKey}`).once("value", snap => {
    const q = snap.val();
    document.getElementById("m-question").value = q.question;
    document.getElementById("m-o0").value = q.options[0];
    document.getElementById("m-o1").value = q.options[1];
    document.getElementById("m-o2").value = q.options[2];
    document.getElementById("m-answer").value = q.answer;
    document.getElementById("m-points").value = q.points;
    document.getElementById("editModal").style.display = "flex";
  });
}

function closeModal(){
  document.getElementById("editModal").style.display = "none";
}

function saveEdit(){
  db.ref(`quizs/${currentQuizId}/questions/${currentQKey}`).update({
    question: m-question.value,
    options: [m-o0.value, m-o1.value, m-o2.value],
    answer: parseInt(m-answer.value),
    points: parseInt(m-points.value)
  }).then(() => {
    closeModal();
    loadQuiz();
  });
}

</script>
<script>
/* ============ AFFICHER TOUS LES QUIZ + LIEN ============ */
const allQuizList = document.getElementById("all-quiz-list");

function loadAllQuizList(){
  allQuizList.innerHTML = "<li>Chargement...</li>";

  db.ref("quizs").once("value", snap => {
    allQuizList.innerHTML = "";

    if(!snap.exists()){
      allQuizList.innerHTML = "<li>Aucun quiz trouv√©</li>";
      return;
    }

    snap.forEach(child => {
      const quizId = child.key;
      const link = `${window.location.origin}/chaine/quiz.html?quiz=${quizId}`;

      allQuizList.innerHTML += `
        <li>
          <b>${quizId}</b><br>
          <input value="${link}" readonly style="width:100%; margin-top:5px">
          <button onclick="navigator.clipboard.writeText('${link}')">
            Copier le lien
          </button>
          <hr>
        </li>
      `;
    });
  });
}

// Charger automatiquement
loadAllQuizList();
</script>
<script>
function deleteQuiz(){
  const quizId = document.getElementById("IdQiz").value.trim();
  if(!quizId) return;

  if(!confirm(`Supprimer d√©finitivement le quiz "${quizId}" ?`)) return;

  db.ref(`quizs/${quizId}`).remove().then(() => {
    alert("Quiz supprim√© üí•");
    document.getElementById("question-list").innerHTML = "";
    loadAllQuizList();
  });
}
</script>
<script>
let dragEl = null;

function enableDrag(quizId){
  document.querySelectorAll("#question-list li").forEach(li => {
    li.ondragstart = () => dragEl = li;
    li.ondragover = e => e.preventDefault();
    li.ondrop = () => {
      if(dragEl === li) return;
      li.before(dragEl);
      saveOrder(quizId);
    };
  });
}

function saveOrder(quizId){
  document.querySelectorAll("#question-list li").forEach((li,i)=>{
    const key = li.dataset.key;
    db.ref(`quizs/${quizId}/questions/${key}`).update({
      order: i
    });
  });
}
</script>
</body>
</html>