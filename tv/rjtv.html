<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<title>RJFORDROID ‚Äì RJ-TV</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="m.css">

</head>
<body>
<!-- OVERLAY -->
<div id="overlay"></div>
  

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="sidebar-header">
    <h2>Menu</h2>
    <button id="closeSidebar"><i class="fa fa-times"></i></button>
  </div>
  <div id="userInfo" style="display:flex;align-items:center;gap:10px;color:white;">
  <i class="fa fa-user-circle" style="font-size:22px;"></i>
  <div>
    <div id="userName" style="font-weight:bold;"></div>
    <small id="userEmail" style="color:gray;"></small>
    <small id="isAdm"></small>
  </div>
</div>

  <ul class="sidebar-links">
    <li><a href="#"><i class="fa fa-home"></i> Accueil</a></li>
    <li><a href="#"><i class="fa fa-video"></i> Vid√©os</a></li>
    <li><a href="#"><i class="fa fa-user"></i> Profil</a></li>
    <li><a href="#"><i class="fa fa-right-from-bracket"></i> D√©connexion</a></li>
  </ul>
</aside>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("openSidebar");
  const closeBtn = document.getElementById("closeSidebar");

  if(!openBtn || !sidebar || !overlay) return;

  openBtn.addEventListener("click", () => {
    sidebar.classList.add("active");
    overlay.classList.add("active");
  });

  closeBtn.addEventListener("click", closeSidebar);
  overlay.addEventListener("click", closeSidebar);

  function closeSidebar(){
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  }
});
</script>

<!-- LOGIN POPUP -->
<div id="loginPopup">
  <div class="login-box">
    <form id="login">
      <h2>Connexion</h2>

      <input type="text" id="loginUsername" placeholder="Email ou Username" required>
      <input type="password" id="loginPassword" placeholder="Mot de passe" required>

      <button type="submit">Se connecter</button>

      <p id="loginMessage"></p>
    </form>
  </div>
</div>
<main>
  <div id="mainVideo">
    <h1>RJ-TV 24 <button id="openSidebar">
    <i class="fa fa-bars"></i>
  </button>
</h1>
    <div id="videoContent">
      <div id="loadingMessage">‚è≥ Loading...</div>
    <video id="videoPlayer"></video>
    <iframe id="iframePlayer"></iframe>
     <p id="title"></p>
<div class="action">
  <button class="like">
    <i class="fa-solid fa-thumbs-up"></i>
    <span id="countLite">0</span>
  </button>

  <p class="views">
    <i class="fa-solid fa-eye"></i>
    <span id="countViews">0</span>
  </p>

  <p class="commentsCount">
    <i class="fa-solid fa-comment"></i>
    <span id="countComments">0</span>
  </p>
  
    <button id="fullScreenBtn" style="background:none; border:none; cursor:pointer; color:black; font-size:18px; margin-left:auto;">
    <i class="fa-solid fa-expand"></i>
  </button>
</div>
    </div>
</div>
  <section class="video-section">
   <div class="contentCommemt">
  <div class="listComment"></div>
  
  <div id="avatarList" class="avatar-picker" style="display:none;"></div>
<div id="avatarList" class="avatar-picker" style="display:none;"></div>


  <div class="comment">
    <textarea id="commentText" placeholder="Ekri yon k√≤mant√®..."></textarea>
    <button class="emoji" type="button" id="btnEmoji">
      <i class="fa-regular fa-face-smile"></i>
    </button>
    <button id="sendComment">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>

  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="user.js"></script>
<script>
/*********************************
 * FIREBASE INIT
 *********************************/
const firebaseConfig = {
  apiKey: "AIzaSyAQeHWr_vUiQmVVgJJ_cOF9qrCCLd7IJNc",
  authDomain: "ayiweb.firebaseapp.com",
  databaseURL: "https://ayiweb-default-rtdb.firebaseio.com",
  projectId: "ayiweb",
  storageBucket: "ayiweb.appspot.com",
  messagingSenderId: "115054504556",
  appId: "1:115054504556:web:ccd713ba01dd8f02830649"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const database = firebase.database();



/*********************************
 * ELEMENTS UI
 *********************************/
const videoEl = document.getElementById("videoPlayer");
const iframeEl = document.getElementById("iframePlayer");
const loadingMessage = document.getElementById("loadingMessage");

const titleEl = document.getElementById("title");
const countViewsEl = document.getElementById("countViews");
const countLiteEl = document.getElementById("countLite");
const countCommentsEl = document.getElementById("countComments");

const likeBtn = document.querySelector(".like");
const commentList = document.querySelector(".listComment");
const commentInput = document.querySelector("textarea");
const sendBtn = document.getElementById("sendComment");
const avatarList = document.getElementById("avatarList");
const btnEmoji = document.getElementById("btnEmoji");

/*********************************
 * GLOBAL
 *********************************/
let currentVideoKey = null;
let currentVideoRef = null;

/*********************************
 * LOAD online VIDEO
 *********************************/
/*********************************
 * LOAD online VIDEO ONLY
 *********************************/
/*********************************
 * LOAD online VIDEO (STRICT)
 *********************************/
database.ref("videos").on("value", snapshot => {
  const videos = snapshot.val();
  let videoFound = false;

  // S√©lection des sections commentaires et actions
  const actionSection = document.querySelector(".action");
  const commentSection = document.querySelector(".contentCommemt");

  snapshot.forEach(childSnapshot => {
    const video = childSnapshot.val();
    
    if (video.enLigne === true) {
      videoFound = true;
      currentVideoKey = childSnapshot.key;
      currentVideoRef = database.ref("videos/" + currentVideoKey);

      loadingMessage.style.display = "none";
      titleEl.textContent = video.title || "";
      
      // Affiche les sections
      if(actionSection) actionSection.style.display = "flex";
      if(commentSection) commentSection.style.display = "flex";

      if (video.type === "mp4" && video.url?.startsWith("http")) {
        iframeEl.style.display = "none";
        videoEl.src = video.url;
        videoEl.style.display = "block";
        
        // IMPORTANT: Charger la vid√©o d'abord
        videoEl.load();
        
        // Tentative de lecture automatique
        const playPromise = videoEl.play();
        
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Lecture automatique r√©ussie
            console.log("Autoplay r√©ussi");
          }).catch(error => {
            // Autoplay bloqu√© - solution de secours
            console.log("Autoplay bloqu√©:", error);
            
            // Option 1: Ajouter un bouton de lecture manuelle
            videoEl.controls = true; // Affiche les contr√¥les
            
            // Option 2: Muter la vid√©o (l'autoplay avec son est souvent bloqu√©)
            videoEl.muted = true;
            videoEl.play().catch(e => console.log("Toujours bloqu√©:", e));
          });
        }
      } else {
        videoEl.style.display = "none";
        videoEl.pause();
        videoEl.src = "";
        
        let youtubeId = video.url;
        if (youtubeId.includes("youtube.com") || youtubeId.includes("youtu.be")) {
          const match = youtubeId.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
          if (match) youtubeId = match[1];
        }
        
        // YouTube avec autoplay
        iframeEl.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1&rel=0&playsinline=1`;
        iframeEl.style.display = "block";
      }

      // Gestion des vues
      const viewedKey = "viewed_" + currentVideoKey;
      if (!localStorage.getItem(viewedKey)) {
        currentVideoRef.child("views").transaction(v => (v || 0) + 1);
        localStorage.setItem(viewedKey, "true");
      }

      // √âcouteurs Firebase
      currentVideoRef.child("views").on("value", snap => { 
        countViewsEl.textContent = snap.val() || 0; 
      });
      
      currentVideoRef.child("Applikes").on("value", snap => { 
        countLiteEl.textContent = snap.val() || 0; 
      });
      
      currentVideoRef.child("comments").on("value", snap => { 
        countCommentsEl.textContent = snap.numChildren(); 
      });

      loadComments();
    }
  });

  // SI AUCUNE VID√âO N'EST EN LIGNE
  if (!videoFound) {
    videoEl.style.display = "none";
    videoEl.pause();
    videoEl.src = "";
    iframeEl.style.display = "none";
    iframeEl.src = "";
    
    // Cache les sections
    if(actionSection) actionSection.style.display = "none";
    if(commentSection) commentSection.style.display = "none";

    // Message d'alerte
    titleEl.innerHTML = `<div style="color: #ff4444; font-weight: bold; padding: 20px; text-align: center;">
      <i class="fa fa-circle-exclamation"></i> TV A FERM√â POU KOUNYE A
    </div>`;
    
    loadingMessage.style.display = "block";
    loadingMessage.innerHTML = `
      <div style="background: rgba(255,0,0,0.1); border: 1px dashed red; padding: 15px; border-radius: 10px;">
        <p style="color: red; margin: 0; font-size: 14px;">üî¥ Estasyon an pa em√®t okenn signal.</p>
        <small style="color: #666;">Tanpri tounen pita.</small>
      </div>
    `;
  }
});
function playVideo(videoElement) {
  const playPromise = videoElement.play();
  
  if (playPromise !== undefined) {
    playPromise.catch(() => {
      // Si autoplay bloqu√©, on mute et on r√©essaie
      videoElement.muted = true;
      videoElement.play().catch(e => {
        console.log("Impossible de lire la vid√©o:", e);
        // Afficher un bouton de lecture manuelle
        showPlayButton();
      });
    });
  }
}

// Copiez cette fonction dans votre code
function unmuteVideoQuandLiJoue(video) {
  if (!video) return;
  
  // Si la vid√©o joue d√©j√†, unmute imm√©diatement
  if (!video.paused) {
    video.muted = false;
    return;
  }
  
  // Sinon, attendre qu'elle joue
  video.addEventListener('play', function unmuteHandler() {
    video.muted = false;
    video.removeEventListener('play', unmuteHandler);
  }, { once: true });
}

// Utilisation:
unmuteVideoQuandLiJoue(videoEl);
/*********************************
 * LIKE SYSTEM (1 par appareil)
 *********************************/
likeBtn.addEventListener("click", () => {

  if (!currentVideoRef) return;

  const likedKey = "liked_" + currentVideoKey;

  if (localStorage.getItem(likedKey)) return;

  currentVideoRef.child("Applikes")
    .transaction(l => (l || 0) + 1);

  localStorage.setItem(likedKey, "true");
  likeBtn.classList.add("active");
});

/*********************************
 * LOAD COMMENTS
 *********************************/
function loadComments() {
  if (!currentVideoKey) return;

  const commentRef = database.ref("videos/" + currentVideoKey + "/comments");
  commentList.innerHTML = "";

  commentRef.limitToLast(50).on("child_added", snap => {
    const comment = snap.val();
    const username = comment.username || "Utilisateur";
    
    // Jwenn premye l√®t la
    const firstLetter = username.charAt(0).toUpperCase();

    const div = document.createElement("div");
    div.className = "comment-item"; // S√®vi ak klas CSS nou an

    div.innerHTML = `
      <div class="avatar-circle">${firstLetter}</div>
      <div style="flex: 1;">
        <strong style="color:lime; font-size: 14px;">${username}</strong>
        <p style="margin:3px 0; color: black; font-size: 15px;">${comment.text}</p>
        <small style="color:black; font-size: 11px;">
          ${new Date(comment.date).toLocaleString()}
        </small>
      </div>
    `;

    commentList.appendChild(div);
    commentList.scrollTop = commentList.scrollHeight;
  });
}


/*********************************
 * SEND COMMENT
 *********************************/
/*********************************
 * SEND COMMENT (WITH LOGIN CHECK)
 *********************************/
sendBtn.addEventListener("click", async () => {

  const text = commentInput.value.trim();
  if (!text || !currentVideoKey) return;

  const uid = localStorage.getItem("connectedUID");

  // ‚ùå Si pa konekte ‚Üí montre login popup
  if (!uid) {
    const loginPopup = document.getElementById("loginPopup");
    loginPopup.classList.add("active");
    return;
  }

  try {

    // ‚úÖ Ch√®che user info
    const snap = await firebase
      .database()
      .ref("RJFORDROID/USERS/" + uid)
      .once("value");

    const user = snap.val();
    if (!user) return;

    const username = user.username || "Utilisateur";

    // ‚úÖ Voye comment ak username
    await database
  .ref("videos/" + currentVideoKey + "/comments")
  .push({
  text: text,
  username: username,
  avatar: selectedAvatar || "",
  uid: uid,
  date: Date.now()
});



    commentInput.value = "";

  } catch (err) {
    console.error("Erreur envoi comment:", err);
  }

});
</script>


<script>
  document.addEventListener("DOMContentLoaded", () => {

  const loginPopup    = document.getElementById("loginPopup");
  const loginForm     = document.getElementById("login");
  const loginUsername = document.getElementById("loginUsername");
  const loginPassword = document.getElementById("loginPassword");
  const loginMessage  = document.getElementById("loginMessage");

  const userNameEl    = document.getElementById("userName");
  const userEmailEl   = document.getElementById("userEmail");
  
  // Seleksyone bouton dekonnyeksyon an nan sidebar la
  const logoutBtn     = document.querySelector(".sidebar-links a i.fa-right-from-bracket")?.parentElement;

  /*********************************
   * 1. TCHEKE SI ITILIZAT√à A TE KONEKTE DEJA
   *********************************/
  const uidStored = localStorage.getItem("connectedUID");

  if (uidStored) {
    loadUserDetails(uidStored);
    loginPopup.classList.remove("active"); // Si l konekte, pa montre popup
  } else {
    // Si w vle popup la par√®t s√®lman l√® l klike sou yon bagay, retire liy anba a
    // loginPopup.classList.add("active"); 
  }

  /*********************************
   * 2. CHACHE ENF√íMASYON NAN FIREBASE
   *********************************/
  /*********************************
   * LOAD USER DETAILS (AK CHECK ADMIN)
   *********************************/
async function loadUserDetails(uid) {
  if (!uid) return;

  const isAdmEl = document.getElementById("isAdm");

  try {
    const snap = await firebase
      .database()
      .ref("RJFORDROID/USERS/" + uid)
      .once("value");

    const user = snap.val();

    console.log("UID:", uid);
    console.log("User data:", user);

    if (!user) return;

    userNameEl.textContent = user.username || "Utilisateur";
    userEmailEl.textContent = user.email || "";

    if (user.role === "admin" || user.isAdmin === true) {
      isAdmEl.textContent = "Admin";
      isAdmEl.style.color = "lime";
      isAdmEl.style.display = "block";
      isAdmEl.style.fontWeight = "bold";
    } else {
      isAdmEl.textContent = "";
      isAdmEl.style.display = "none";
    }

  } catch (err) {
    console.error("Erreur chargement user:", err);
  }
}



  /*********************************
   * 3. SIST√àM LOGIN LAN
   *********************************/
  loginForm.addEventListener("submit", async e => {
    e.preventDefault();

    const identifier = loginUsername.value.trim();
    const password   = loginPassword.value.trim();

    loginMessage.style.color = "orange";
    loginMessage.textContent = "Connexion...";

    try {
      const snap = await firebase.database().ref("RJFORDROID/USERS").once("value");
      const users = snap.val() || {};
      let uid = null;

      for (const k in users) {
        const u = users[k];
        if ((u.username === identifier || u.email === identifier) && u.password === password) {
          uid = k;
          break;
        }
      }

      if (!uid) {
        loginMessage.style.color = "red";
        loginMessage.textContent = "Identifiants incorrects";
        return;
      }

      // SOVE UID A NAN MEMWA TELEF√íN NAN
      localStorage.setItem("connectedUID", uid);

      loginMessage.style.color = "lime";
      loginMessage.textContent = "Connexion r√©ussie";

      loadUserDetails(uid);

      setTimeout(() => {
        loginPopup.classList.remove("active");
      }, 800);

    } catch (err) {
      loginMessage.style.color = "red";
      loginMessage.textContent = "Erreur connexion";
    }
  });

  /*********************************
   * 4. SIST√àM DEKONNYEKSYON (LOGOUT)
   *********************************/
  if (logoutBtn) {
    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("connectedUID"); // Efase UID a
      location.reload(); // Rafrechi paj la pou reset tout bagay
    });
  }

});

</script>
</body>
</html>